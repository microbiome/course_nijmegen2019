<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 Advanced models for differential abundance | Introduction to microbiome data science</title>
  <meta name="description" content="Course material" />
  <meta name="generator" content="bookdown 0.12 and GitBook 2.6.7" />

  <meta property="og:title" content="6 Advanced models for differential abundance | Introduction to microbiome data science" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Course material" />
  <meta name="github-repo" content="microbiome/test" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Advanced models for differential abundance | Introduction to microbiome data science" />
  
  <meta name="twitter:description" content="Course material" />
  

<meta name="author" content="Leo Lahti" />


<meta name="date" content="2019-07-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="linear-models-the-role-of-covariates.html">
<link rel="next" href="multivariate-comparisons-of-microbial-community-composition.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#preparing-for-the-course"><i class="fa fa-check"></i><b>1.1</b> Preparing for the course</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#useful-functionsresources"><i class="fa fa-check"></i><b>1.2</b> Useful functions/resources</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#focus"><i class="fa fa-check"></i><b>1.3</b> Focus</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#target-audience"><i class="fa fa-check"></i><b>1.4</b> Target audience</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#citation"><i class="fa fa-check"></i><b>1.5</b> Citation</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i><b>1.6</b> License</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="set-up-and-pre-processing.html"><a href="set-up-and-pre-processing.html"><i class="fa fa-check"></i><b>2</b> Set-up and Pre-processing</a><ul>
<li class="chapter" data-level="2.1" data-path="set-up-and-pre-processing.html"><a href="set-up-and-pre-processing.html#otu-or-asvs-or-sotus"><i class="fa fa-check"></i><b>2.1</b> OTU or ASVs or sOTUs</a></li>
<li class="chapter" data-level="2.2" data-path="set-up-and-pre-processing.html"><a href="set-up-and-pre-processing.html#general-overview"><i class="fa fa-check"></i><b>2.2</b> General overview</a></li>
<li class="chapter" data-level="2.3" data-path="set-up-and-pre-processing.html"><a href="set-up-and-pre-processing.html#structure"><i class="fa fa-check"></i><b>2.3</b> Structure</a></li>
<li class="chapter" data-level="2.4" data-path="set-up-and-pre-processing.html"><a href="set-up-and-pre-processing.html#making-a-phyloseq-object"><i class="fa fa-check"></i><b>2.4</b> Making a phyloseq object</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="course-overview.html"><a href="course-overview.html"><i class="fa fa-check"></i><b>3</b> Course overview</a><ul>
<li class="chapter" data-level="3.1" data-path="course-overview.html"><a href="course-overview.html#september"><i class="fa fa-check"></i><b>3.1</b> 12 September:</a></li>
<li class="chapter" data-level="3.2" data-path="course-overview.html"><a href="course-overview.html#september-1"><i class="fa fa-check"></i><b>3.2</b> 13 September:</a></li>
<li class="chapter" data-level="3.3" data-path="course-overview.html"><a href="course-overview.html#material"><i class="fa fa-check"></i><b>3.3</b> Material</a></li>
<li class="chapter" data-level="3.4" data-path="course-overview.html"><a href="course-overview.html#literature"><i class="fa fa-check"></i><b>3.4</b> Literature</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="differential-abundance-testing-for-univariate-data.html"><a href="differential-abundance-testing-for-univariate-data.html"><i class="fa fa-check"></i><b>4</b> Differential abundance testing for univariate data</a><ul>
<li class="chapter" data-level="4.1" data-path="differential-abundance-testing-for-univariate-data.html"><a href="differential-abundance-testing-for-univariate-data.html#load-example-data"><i class="fa fa-check"></i><b>4.1</b> Load example data</a></li>
<li class="chapter" data-level="4.2" data-path="differential-abundance-testing-for-univariate-data.html"><a href="differential-abundance-testing-for-univariate-data.html#visual-comparison-of-two-groups"><i class="fa fa-check"></i><b>4.2</b> Visual comparison of two groups</a></li>
<li class="chapter" data-level="4.3" data-path="differential-abundance-testing-for-univariate-data.html"><a href="differential-abundance-testing-for-univariate-data.html#statistical-comparison-of-two-groups"><i class="fa fa-check"></i><b>4.3</b> Statistical comparison of two groups</a></li>
<li class="chapter" data-level="4.4" data-path="differential-abundance-testing-for-univariate-data.html"><a href="differential-abundance-testing-for-univariate-data.html#investigate-assumptions-of-the-t-test"><i class="fa fa-check"></i><b>4.4</b> Investigate assumptions of the t-test</a></li>
<li class="chapter" data-level="4.5" data-path="differential-abundance-testing-for-univariate-data.html"><a href="differential-abundance-testing-for-univariate-data.html#compare-results-between-parametric-and-non-parametric-tests"><i class="fa fa-check"></i><b>4.5</b> Compare results between parametric and non-parametric tests</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="linear-models-the-role-of-covariates.html"><a href="linear-models-the-role-of-covariates.html"><i class="fa fa-check"></i><b>5</b> Linear models: the role of covariates</a><ul>
<li class="chapter" data-level="5.1" data-path="linear-models-the-role-of-covariates.html"><a href="linear-models-the-role-of-covariates.html#fitting-a-linear-model"><i class="fa fa-check"></i><b>5.1</b> Fitting a linear model</a></li>
<li class="chapter" data-level="5.2" data-path="linear-models-the-role-of-covariates.html"><a href="linear-models-the-role-of-covariates.html#interpreting-linear-model-output"><i class="fa fa-check"></i><b>5.2</b> Interpreting linear model output</a></li>
<li class="chapter" data-level="5.3" data-path="linear-models-the-role-of-covariates.html"><a href="linear-models-the-role-of-covariates.html#covariate-testing"><i class="fa fa-check"></i><b>5.3</b> Covariate testing</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html"><i class="fa fa-check"></i><b>6</b> Advanced models for differential abundance</a><ul>
<li class="chapter" data-level="6.1" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html#particular-properties-of-taxonomic-profiling-data"><i class="fa fa-check"></i><b>6.1</b> Particular properties of taxonomic profiling data</a><ul>
<li class="chapter" data-level="6.1.1" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html#discrete-count-data"><i class="fa fa-check"></i><b>6.1.1</b> Discrete count data</a></li>
<li class="chapter" data-level="6.1.2" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html#sparsity"><i class="fa fa-check"></i><b>6.1.2</b> Sparsity</a></li>
<li class="chapter" data-level="6.1.3" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html#rarity"><i class="fa fa-check"></i><b>6.1.3</b> Rarity</a></li>
<li class="chapter" data-level="6.1.4" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html#overdispersion"><i class="fa fa-check"></i><b>6.1.4</b> Overdispersion</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html#generalized-linear-models-a-brief-overview"><i class="fa fa-check"></i><b>6.2</b> Generalized linear models: a brief overview</a></li>
<li class="chapter" data-level="6.3" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html#deseq2-differential-abundance-testing-for-sequencing-data"><i class="fa fa-check"></i><b>6.3</b> DESeq2: differential abundance testing for sequencing data</a><ul>
<li class="chapter" data-level="6.3.1" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html#fitting-deseq2"><i class="fa fa-check"></i><b>6.3.1</b> Fitting DESeq2</a></li>
<li class="chapter" data-level="6.3.2" data-path="advanced-models-for-differential-abundance.html"><a href="advanced-models-for-differential-abundance.html#comparison-between-deseq2-and-standard-models"><i class="fa fa-check"></i><b>6.3.2</b> Comparison between DESeq2 and standard models</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="multivariate-comparisons-of-microbial-community-composition.html"><a href="multivariate-comparisons-of-microbial-community-composition.html"><i class="fa fa-check"></i><b>7</b> Multivariate comparisons of microbial community composition</a><ul>
<li class="chapter" data-level="7.1" data-path="multivariate-comparisons-of-microbial-community-composition.html"><a href="multivariate-comparisons-of-microbial-community-composition.html#permanova"><i class="fa fa-check"></i><b>7.1</b> PERMANOVA</a></li>
<li class="chapter" data-level="7.2" data-path="multivariate-comparisons-of-microbial-community-composition.html"><a href="multivariate-comparisons-of-microbial-community-composition.html#checking-the-homogeneity-condition"><i class="fa fa-check"></i><b>7.2</b> Checking the homogeneity condition</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="further-exercises.html"><a href="further-exercises.html"><i class="fa fa-check"></i><b>8</b> Further exercises</a><ul>
<li class="chapter" data-level="8.1" data-path="further-exercises.html"><a href="further-exercises.html#compositionality"><i class="fa fa-check"></i><b>8.1</b> Compositionality</a></li>
<li class="chapter" data-level="8.2" data-path="further-exercises.html"><a href="further-exercises.html#redundancy-analysis-rda"><i class="fa fa-check"></i><b>8.2</b> Redundancy analysis (RDA)</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="citation-1.html"><a href="citation-1.html"><i class="fa fa-check"></i><b>9</b> Citation</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Introduction to microbiome data science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="advanced-models-for-differential-abundance" class="section level1">
<h1><span class="header-section-number">6</span> Advanced models for differential abundance</h1>
<p>GLMs are the basis for advanced testing of differential abundance in sequencing data. This is necessary, as the sequencing data sets deviate from symmetric, continuous, Gaussian assumptions in many ways.</p>
<div id="particular-properties-of-taxonomic-profiling-data" class="section level2">
<h2><span class="header-section-number">6.1</span> Particular properties of taxonomic profiling data</h2>
<div id="discrete-count-data" class="section level3">
<h3><span class="header-section-number">6.1.1</span> Discrete count data</h3>
<p>Sequencing data consists of discrete counts:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">abundances</span>(d)[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</code></pre></div>
<pre><code>##                              Sample-1 Sample-2 Sample-3
## Actinomycetaceae                    0        1        0
## Aerococcus                          0        0        0
## Aeromonas                           0        0        0
## Akkermansia                        18       97       67
## Alcaligenes faecalis et rel.        1        2        3</code></pre>
</div>
<div id="sparsity" class="section level3">
<h3><span class="header-section-number">6.1.2</span> Sparsity</h3>
<p>The data is sparse:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">hist</span>(<span class="kw">log10</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">abundances</span>(d)), <span class="dv">100</span>)</code></pre></div>
<p><img src="_main_files/figure-html/pooled3-1.png" width="768" /></p>
</div>
<div id="rarity" class="section level3">
<h3><span class="header-section-number">6.1.3</span> Rarity</h3>
<p>Long tails of rare taxa:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(reshape2)
medians &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">abundances</span>(d),<span class="dv">1</span>,median)<span class="op">/</span><span class="fl">1e3</span>
A &lt;-<span class="st"> </span><span class="kw">melt</span>(<span class="kw">abundances</span>(d))
A<span class="op">$</span>Var1 &lt;-<span class="st"> </span><span class="kw">factor</span>(A<span class="op">$</span>Var1, <span class="dt">levels =</span> <span class="kw">rev</span>(<span class="kw">names</span>(<span class="kw">sort</span>(medians))))
p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(A, <span class="kw">aes</span>(<span class="dt">x =</span> Var1, <span class="dt">y =</span> value)) <span class="op">+</span>
<span class="st">        </span><span class="kw">geom_boxplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Abundance (reads)&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Taxonomic Group&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_log10</span>()
    
<span class="kw">print</span>(p)</code></pre></div>
<p><img src="_main_files/figure-html/tail-1.png" width="600px" /></p>
</div>
<div id="overdispersion" class="section level3">
<h3><span class="header-section-number">6.1.4</span> Overdispersion</h3>
<p>Variance exceeds the mean:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">means &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">abundances</span>(d),<span class="dv">1</span>,mean)
variances &lt;-<span class="st"> </span><span class="kw">apply</span>(<span class="kw">abundances</span>(d),<span class="dv">1</span>,var)

<span class="co"># Calculate mean and variance over samples for each taxon</span>
<span class="kw">library</span>(reshape2)
<span class="kw">library</span>(dplyr)
df &lt;-<span class="st"> </span><span class="kw">melt</span>(<span class="kw">abundances</span>(d))
<span class="kw">names</span>(df) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Taxon&quot;</span>, <span class="st">&quot;Sample&quot;</span>, <span class="st">&quot;Reads&quot;</span>)
df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Taxon) <span class="op">%&gt;%</span>
<span class="st">             </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(Reads),
                   <span class="dt">variance =</span> <span class="kw">var</span>(Reads))

<span class="co"># Illustrate overdispersion</span>
<span class="kw">library</span>(scales)
p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(df, <span class="kw">aes</span>(<span class="dt">x =</span> mean, <span class="dt">y =</span> variance)) <span class="op">+</span>
<span class="st">       </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">       </span><span class="kw">geom_abline</span>(<span class="kw">aes</span>(<span class="dt">intercept =</span> <span class="dv">0</span>, <span class="dt">slope =</span> <span class="dv">1</span>)) <span class="op">+</span>
<span class="st">       </span><span class="kw">scale_x_log10</span>(<span class="dt">labels =</span> scales<span class="op">::</span>scientific) <span class="op">+</span>
<span class="st">       </span><span class="kw">scale_y_log10</span>(<span class="dt">labels =</span> scales<span class="op">::</span>scientific) <span class="op">+</span>
<span class="st">       </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Overdispersion (variance &gt; mean)&quot;</span>)
<span class="kw">print</span>(p)</code></pre></div>
<p><img src="_main_files/figure-html/pooled_overdispersion-1.png" width="600px" /></p>
</div>
</div>
<div id="generalized-linear-models-a-brief-overview" class="section level2">
<h2><span class="header-section-number">6.2</span> Generalized linear models: a brief overview</h2>
<p>Let us briefly discuss the ideas underlying generalized linear models.</p>
<p>The Generalized linear model (GLM) allows a richer family of probability distributions to describe the data. Intuitively speaking, GLMs allow the modeling of nonlinear, nonsymmetric, and nongaussian associations. GLMs consist of three elements:</p>
<ul>
<li><p>A probability distribution for the data (from exponential family)</p></li>
<li><p>A linear predictor targeting the mean, or expectation: <span class="math inline">\(Xb\)</span></p></li>
<li><p>A link function g such that <span class="math inline">\(E(Y) = \mu = g^{-1}(Xb)\)</span>.</p></li>
</ul>
<p>Let us fit Poisson with (natural) log-link just to demonstrate how generalized linear models could be fitted in R. We fit the abundance (read counts) assuming that the data is Poisson distributed, and the logarithm of its mean, or expectation, is obtained with a linear model. For further examples in R, you can also check the <a href="https://www.statmethods.net/advstats/glm.html">statmethods website</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load again the example data</span>
d &lt;-<span class="st"> </span>dietswap
df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Abundance =</span> <span class="kw">abundances</span>(d)[taxa,],
                 <span class="dt">Group =</span> <span class="kw">meta</span>(d)<span class="op">$</span>nationality)

res &lt;-<span class="st"> </span><span class="kw">glm</span>(Abundance <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> df, <span class="dt">family =</span> <span class="st">&quot;poisson&quot;</span>)</code></pre></div>
<p>Investigate the model output:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">summary</span>(res)<span class="op">$</span>coefficients, <span class="dt">digits =</span> <span class="dv">5</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">Estimate</th>
<th align="right">Std. Error</th>
<th align="right">z value</th>
<th align="right">Pr(&gt;|z|)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>(Intercept)</td>
<td align="right">2.09286</td>
<td align="right">0.02357</td>
<td align="right">88.79275</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>Note the link between mean and estimated coefficient (<span class="math inline">\(\mu = e^{Xb}\)</span>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(df<span class="op">$</span>Abundance)</code></pre></div>
<pre><code>## [1] 8.108108</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">exp</span>(<span class="kw">coef</span>(res))</code></pre></div>
<pre><code>## (Intercept) 
##    8.108108</code></pre>
</div>
<div id="deseq2-differential-abundance-testing-for-sequencing-data" class="section level2">
<h2><span class="header-section-number">6.3</span> DESeq2: differential abundance testing for sequencing data</h2>
<div id="fitting-deseq2" class="section level3">
<h3><span class="header-section-number">6.3.1</span> Fitting DESeq2</h3>
<p>[DESeq2 analysis]((<a href="https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0550-8" class="uri">https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0550-8</a>) accommodates those particular assumptions about sequencing data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Start by converting phyloseq object to deseq2 format</span>
<span class="kw">library</span>(DESeq2)
d &lt;-<span class="st"> </span>dietswap <span class="co"># Phyloseq data</span>
ds2 &lt;-<span class="st"> </span><span class="kw">phyloseq_to_deseq2</span>(d, <span class="op">~</span><span class="st"> </span>group <span class="op">+</span><span class="st"> </span>nationality)

<span class="co"># Run DESeq2 analysis (all taxa at once!)</span>
dds &lt;-<span class="st"> </span><span class="kw">DESeq</span>(ds2)

<span class="co"># Investigate results</span>
deseq.results &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">results</span>(dds))
deseq.results<span class="op">$</span>taxon &lt;-<span class="st"> </span><span class="kw">rownames</span>(<span class="kw">results</span>(dds))

<span class="co"># Sort (arrange) by pvalue and effect size</span>
<span class="kw">library</span>(knitr)
deseq.results &lt;-<span class="st"> </span>deseq.results <span class="op">%&gt;%</span>
<span class="st">                   </span><span class="kw">arrange</span>(pvalue, log2FoldChange)

<span class="co"># Print the result table</span>
<span class="co"># Let us only show significant hits</span>
knitr<span class="op">::</span><span class="kw">kable</span>(deseq.results <span class="op">%&gt;%</span>
<span class="st">               </span><span class="kw">filter</span>(pvalue <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span> <span class="op">&amp;</span><span class="st"> </span>log2FoldChange <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.5</span>),
         <span class="dt">digits =</span> <span class="dv">5</span>)</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">baseMean</th>
<th align="right">log2FoldChange</th>
<th align="right">lfcSE</th>
<th align="right">stat</th>
<th align="right">pvalue</th>
<th align="right">padj</th>
<th align="left">taxon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">29.20535</td>
<td align="right">1.91205</td>
<td align="right">0.13432</td>
<td align="right">14.23457</td>
<td align="right">0.00000</td>
<td align="right">0.00000</td>
<td align="left">Clostridium difficile et rel.</td>
</tr>
<tr class="even">
<td align="right">51.65152</td>
<td align="right">3.04116</td>
<td align="right">0.28687</td>
<td align="right">10.60107</td>
<td align="right">0.00000</td>
<td align="right">0.00000</td>
<td align="left">Mitsuokella multiacida et rel.</td>
</tr>
<tr class="odd">
<td align="right">12.39749</td>
<td align="right">1.83825</td>
<td align="right">0.18531</td>
<td align="right">9.91994</td>
<td align="right">0.00000</td>
<td align="right">0.00000</td>
<td align="left">Klebisiella pneumoniae et rel.</td>
</tr>
<tr class="even">
<td align="right">44.16494</td>
<td align="right">1.78333</td>
<td align="right">0.23072</td>
<td align="right">7.72937</td>
<td align="right">0.00000</td>
<td align="right">0.00000</td>
<td align="left">Megasphaera elsdenii et rel.</td>
</tr>
<tr class="odd">
<td align="right">66.93783</td>
<td align="right">1.68345</td>
<td align="right">0.25330</td>
<td align="right">6.64609</td>
<td align="right">0.00000</td>
<td align="right">0.00000</td>
<td align="left">Escherichia coli et rel.</td>
</tr>
<tr class="even">
<td align="right">3.63459</td>
<td align="right">1.53142</td>
<td align="right">0.23140</td>
<td align="right">6.61792</td>
<td align="right">0.00000</td>
<td align="right">0.00000</td>
<td align="left">Weissella et rel.</td>
</tr>
<tr class="odd">
<td align="right">5.74035</td>
<td align="right">3.07334</td>
<td align="right">0.47848</td>
<td align="right">6.42308</td>
<td align="right">0.00000</td>
<td align="right">0.00000</td>
<td align="left">Serratia</td>
</tr>
<tr class="even">
<td align="right">0.42171</td>
<td align="right">1.70079</td>
<td align="right">0.47147</td>
<td align="right">3.60743</td>
<td align="right">0.00031</td>
<td align="right">0.00075</td>
<td align="left">Moraxellaceae</td>
</tr>
</tbody>
</table>
</div>
<div id="comparison-between-deseq2-and-standard-models" class="section level3">
<h3><span class="header-section-number">6.3.2</span> Comparison between DESeq2 and standard models</h3>
<p>For comparison purposes, assess significances and effect sizes based on Wilcoxon test.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test.taxa &lt;-<span class="st"> </span><span class="kw">taxa</span>(d)
pvalue.wilcoxon &lt;-<span class="st"> </span><span class="kw">c</span>()
foldchange &lt;-<span class="st"> </span><span class="kw">c</span>()
<span class="cf">for</span> (taxa <span class="cf">in</span> test.taxa) {
  <span class="co"># Create a new data frame for each taxonomic group</span>
  df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Abundance =</span> <span class="kw">abundances</span>(d)[taxa,],
                   <span class="dt">Log10_Abundance =</span> <span class="kw">log10</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">abundances</span>(d)[taxa,]),
                   <span class="dt">Group =</span> <span class="kw">meta</span>(d)<span class="op">$</span>nationality)
  <span class="co"># Calculate pvalue and effect size (difference beween log means)       </span>
  pvalue.wilcoxon[[taxa]] &lt;-<span class="st"> </span><span class="kw">wilcox.test</span>(Abundance <span class="op">~</span><span class="st"> </span>Group, <span class="dt">data =</span> df)<span class="op">$</span>p.value
  foldchange[[taxa]] &lt;-<span class="st"> </span><span class="kw">coef</span>(<span class="kw">lm</span>(Log10_Abundance <span class="op">~</span><span class="st"> </span>Group, <span class="dt">data =</span> df))[[<span class="dv">2</span>]]
}
<span class="co"># Correct p-values for multiple testing</span>
pvalue.wilcoxon.adjusted &lt;-<span class="st"> </span><span class="kw">p.adjust</span>(pvalue.wilcoxon)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">plot</span>(deseq.results<span class="op">$</span>padj, pvalue.wilcoxon.adjusted,
  <span class="dt">xlab =</span> <span class="st">&quot;DESeq2 adjusted p-value&quot;</span>,
  <span class="dt">ylab =</span> <span class="st">&quot;Wilcoxon adjusted p-value&quot;</span>,
  <span class="dt">main =</span> <span class="st">&quot;P-value comparison&quot;</span>)
<span class="kw">abline</span>(<span class="dt">v =</span> <span class="fl">0.05</span>, <span class="dt">h =</span> <span class="fl">0.05</span>, <span class="dt">lty =</span> <span class="dv">2</span>)

<span class="kw">plot</span>(deseq.results<span class="op">$</span>log2FoldChange, foldchange, 
  <span class="dt">xlab =</span> <span class="st">&quot;DESeq2&quot;</span>,
  <span class="dt">ylab =</span> <span class="st">&quot;Linear model&quot;</span>,
  <span class="dt">main =</span> <span class="st">&quot;Effect size comparison&quot;</span>)
<span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>)</code></pre></div>
<p><img src="_main_files/figure-html/pooled_pcomp-1.png" width="960" /></p>
<p>For systematic comparisons between various methods for differential abundance testing, see <a href="https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-017-0237-y">this paper</a>.</p>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="linear-models-the-role-of-covariates.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="multivariate-comparisons-of-microbial-community-composition.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
